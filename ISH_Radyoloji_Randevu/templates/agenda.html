{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('month') }}">Ay</a>
    <form method="get" action="{{ url_for('agenda') }}" class="d-flex gap-2">
      <input type="date" class="form-control" name="date" value="{{ day_iso }}">
      <button class="btn btn-outline-secondary">Günü Aç</button>
    </form>
    <div class="ms-3 fw-semibold">Tarih: {{ day_iso|tr_date }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-success" href="{{ url_for('new', date=day_iso) }}">+ Yeni Randevu</a>
  </div>
</div>

{% if appts|length == 0 %}
  <div class="alert alert-info">Bu günde randevu yok.</div>
{% else %}
  <div class="list-group">
    {% for a in appts %}
      <div class="list-group-item appt {% if a.anesthesia %}anesthesia{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>{{ a.custom_proc_name or a.proc_name }}</strong>
            <div class="small text-muted">Süre: {{ a.duration_min }} dk</div>
          </div>

          <form method="post"
                action="{{ url_for('delete_appt', appt_id=a.id) }}"
                onsubmit="return confirm('Bu randevuyu silmek istediğinize emin misiniz?');">
            <input type="hidden" name="day_iso" value="{{ day_iso }}">
            <button type="submit" class="btn btn-sm btn-outline-danger">Sil</button>
          </form>
        </div>

        <div><strong>Hasta:</strong> {{ a.patient_name }} {% if a.tc_no %} ({{ a.tc_no }}){% endif %}</div>
        <div class="small text-muted">
          İlaç:
          {% if a.anticoagulant %} Antikoagülan{% endif %}
          {% if a.antiplatelet %} {% if a.anticoagulant %}+{% endif %} Antiagregan{% endif %}
          {% if not a.anticoagulant and not a.antiplatelet %} — {% endif %}
          {% if a.med_note %} • Not: {{ a.med_note }}{% endif %}
          {% if a.anesthesia %} • <strong>Anestezi</strong>{% endif %}
        </div>
        {% if a.prep_json %}
          {% set pj = a.prep_json|safe %}
          {% set prep = pj and pj is string and (pj|loads) or {} %}
          {% if prep.lab or prep.hazirlik %}
            <div class="small mt-1">
              <em>Hazırlık/Lab:</em>
              {% if prep.lab %} {{ prep.lab }} {% endif %}
              {% if prep.hazirlik %} • {{ prep.hazirlik }} {% endif %}
            </div>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}
