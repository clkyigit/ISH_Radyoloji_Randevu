{% extends "base.html" %}
{% block content %}
<h5>{{ day_iso|tr_date }} — Yeni Randevu</h5>
<form method="post" class="card card-body">
  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Hasta adı</label>
      <input name="patient_name" class="form-control" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">TC Kimlik No (opsiyonel)</label>
      <input name="patient_tc" maxlength="11" pattern="[0-9]{0,11}" class="form-control" placeholder="11 hane (ops.)">
      <div class="form-text">Doldurulması zorunlu değil.</div>
    </div>

    <div class="col-md-3">
      <label class="form-label">İşlem türü</label>
      <select name="procedure_type_id" id="proc" class="form-select" required>
        <option value="" selected disabled>Seçiniz…</option>
        {% for p in procs %}
          <option value="{{ p.id }}" data-name="{{ p.name }}" data-dur="{{ p.default_duration_min }}" data-req='{{ p.requirements_json|safe }}'>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Süre (dk)</label>
      <input name="duration_min" id="dur" type="number" class="form-control" min="10" step="5" value="60" required>
    </div>

    <!-- Diğer seçilince açılan alan -->
    <div class="col-md-6" id="customProcWrap" style="display:none;">
      <label class="form-label">İşlem adı (Diğer)</label>
      <input name="custom_proc_name" id="custom_proc_name" class="form-control" placeholder="Örn. özel işlem adı">
      <div class="form-text">Sadece “Diğer (serbest giriş)” seçildiğinde doldurun.</div>
    </div>

    <div class="col-md-12">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="anticoagulant" id="antico">
        <label class="form-check-label" for="antico">Antikoagülan</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="antiplatelet" id="antiag">
        <label class="form-check-label" for="antiag">Antiagregan</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="anesthesia" id="anes">
        <label class="form-check-label" for="anes">Anestezi uygulanacak</label>
      </div>
    </div>

    <div class="col-md-12">
      <label class="form-label">İşlem Notu (opsiyonel)</label>
      <input name="med_note" class="form-control" placeholder="Örn. ASA+Klopidogrel, son doz dün; özel istek…">
    </div>

    <div class="col-md-6">
      <label class="form-label">Laboratuvar notu (opsiyonel)</label>
      <textarea name="lab_notes" class="form-control" rows="2" placeholder="Örn. INR 1.3, Plt 120k; eGFR 58; vb."></textarea>
    </div>
    <div class="col-md-6">
      <label class="form-label">Hazırlık hatırlatma notu (opsiyonel)</label>
      <textarea name="prep_notes" class="form-control" rows="2" placeholder="Örn. Açlık ≥6s, Metformin 48s kesildi, onam alındı…"></textarea>
    </div>

    <div class="col-md-12">
      <label class="form-label">Öneri checklist (opsiyonel)</label>
      <div id="reqBox" class="d-flex flex-column gap-1"></div>
      <div class="form-text">Bunlar öneridir; işaretlemek zorunlu değildir.</div>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary">Kaydet</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('agenda', date=day_iso) }}">Geri</a>
  </div>
</form>

<script>
  const procSel = document.getElementById('proc');
  const durInput = document.getElementById('dur');
  const reqBox  = document.getElementById('reqBox');
  const customWrap = document.getElementById('customProcWrap');
  const customName = document.getElementById('custom_proc_name');

  function updateForProc() {
    const opt = procSel.selectedOptions[0];
    if (!opt) return;
    const dur = opt.getAttribute('data-dur');
    const req = opt.getAttribute('data-req');
    const name = (opt.getAttribute('data-name') || "").toLowerCase();

    if (dur) durInput.value = dur;

    reqBox.innerHTML = "";
    if (req) {
      try {
        const data = JSON.parse(req);
        (data.checklist || []).forEach((item, idx) => {
          const id = `req_${idx}`;
          reqBox.insertAdjacentHTML('beforeend',
            `<div class="form-check">
               <input class="form-check-input" type="checkbox" name="req_checked" value="${item}" id="${id}">
               <label class="form-check-label" for="${id}">${item}</label>
             </div>`);
        });
      } catch {}
    }

    if (name.includes("diğer")) {
      customWrap.style.display = '';
      customName.required = false;
    } else {
      customWrap.style.display = 'none';
      customName.value = '';
      customName.required = false;
    }
  }

  procSel.addEventListener('change', updateForProc);
</script>
{% endblock %}
