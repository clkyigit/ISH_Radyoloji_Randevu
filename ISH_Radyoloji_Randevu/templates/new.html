{% extends "base.html" %}
{% block content %}
<h5>{{ day_iso|tr_date }} — Yeni Randevu</h5>
<form method="post" class="card card-body">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label">TC Kimlik No (opsiyonel)</label>
      <input name="tc_no" class="form-control" maxlength="11">
    </div>
    <div class="col-md-5">
      <label class="form-label">Hasta adı</label>
      <input name="patient_name" class="form-control" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">İşlem türü</label>
      <select name="procedure_type_id" id="proc" class="form-select" required>
        <option value="" selected disabled>Seçiniz…</option>
        {% for p in procs %}
          <option value="{{ p.id }}"
                  data-name="{{ p.name }}"
                  data-dur="{{ p.default_duration_min }}"
                  data-req='{{ p.requirements_json|safe }}'>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Süre (dk)</label>
      <input name="duration_min" id="dur" type="number" class="form-control" min="10" step="5" value="60" required>
    </div>

    <div class="col-md-6" id="customWrap" style="display:none;">
      <label class="form-label">İşlem adı (Diğer)</label>
      <input name="custom_proc_name" id="custom_proc_name" class="form-control" placeholder="Özel işlem adı">
    </div>

    <div class="col-md-12">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="anticoagulant" id="antico">
        <label class="form-check-label" for="antico">Antikoagülan</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="antiplatelet" id="antiag">
        <label class="form-check-label" for="antiag">Antiagregan</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="anesthesia" id="anes">
        <label class="form-check-label" for="anes">Anestezi uygulanacak</label>
      </div>
    </div>

    <div class="col-md-12">
      <label class="form-label">İşlem Notu</label>
      <input name="med_note" class="form-control" placeholder="ASA+Klopidogrel, özel istek vb.">
    </div>

    <div class="col-md-6">
      <label class="form-label">Lab hatırlatması (opsiyonel)</label>
      <input name="prep_lab" class="form-control" placeholder="INR ≤1.5, Plt ≥50k, GFR vb.">
    </div>
    <div class="col-md-6">
      <label class="form-label">Hazırlık notu (opsiyonel)</label>
      <input name="prep_prep" class="form-control" placeholder="Açlık, ilaç kesimi vb.">
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary">Kaydet</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('agenda', date=day_iso) }}">Geri</a>
  </div>
</form>

<script>
  const procSel = document.getElementById('proc');
  const durInput = document.getElementById('dur');
  const customWrap = document.getElementById('customWrap');
  const customName = document.getElementById('custom_proc_name');

  function updateForProc() {
    const opt = procSel.selectedOptions[0];
    if (!opt) return;
    const dur = opt.getAttribute('data-dur');
    const name = (opt.getAttribute('data-name') || "").toLowerCase();
    if (dur) durInput.value = dur;
    if (name.includes("diğer")) {
      customWrap.style.display = '';
    } else {
      customWrap.style.display = 'none';
      customName.value = '';
    }
  }
  procSel.addEventListener('change', updateForProc);
</script>
{% endblock %}
