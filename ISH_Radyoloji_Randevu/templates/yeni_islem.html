{% extends 'base.html' %}
{% block title %}Yeni Randevu Ekle{% endblock %}
{% block content %}
<div class="form-container single-page-form">
    <form action="{{ url_for('islem_ekle') }}" method="post">
        <div class="form-grid">
            <div class="form-column">
                <fieldset>
                    <legend>Hasta ve Zamanlama</legend>
                    <div class="form-group">
                        <label for="hasta_adi">Hasta Adı Soyadı:</label>
                        <input type="text" id="hasta_adi" name="hasta_adi" required placeholder="Örn: Ahmet Yılmaz">
                    </div>
                    <div class="form-group">
                        <label for="islem_tarihi">İşlem Günü:</label>
                        <input type="date" id="islem_tarihi" name="islem_tarihi" required>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>İşlem Detayları</legend>
                    <div class="form-group">
                        <label>İşlem Kategorisi:</label>
                        <div class="radio-group">
                            <input type="radio" id="skopi-gerektirmeyen-radio" name="kategori" value="Skopi Gerektirmeyen" onclick="kategoriDegistir()" checked>
                            <label for="skopi-gerektirmeyen-radio">Skopi Gerektirmeyen</label>
                            <input type="radio" id="skopi-gerektiren-radio" name="kategori" value="Skopi Gerektiren" onclick="kategoriDegistir()">
                            <label for="skopi-gerektiren-radio">Skopi Gerektiren</label>
                        </div>
                    </div>
                    <div id="skopi-gerektirmeyen-secim" class="form-group">
                        <label for="islem_adi_skopi_gerektirmeyen">İşlem Adı:</label>
                        <select name="islem_adi_skopi_gerektirmeyen" id="islem-secim-listesi-1" onchange="islemDetayGetir(this)">
                            {% for islem in skopi_gerektirmeyen %}<option value="{{ islem }}">{{ islem }}</option>{% endfor %}
                        </select>
                    </div>
                    <div id="skopi-gerektiren-secim" class="form-group" style="display: none;">
                        <label for="islem_adi_skopi_gerektiren">İşlem Adı:</label>
                        <select name="islem_adi_skopi_gerektiren" id="islem-secim-listesi-2" onchange="islemDetayGetir(this)" disabled>
                            {% for islem in skopi_gerektiren %}<option value="{{ islem }}">{{ islem }}</option>{% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="anestezi_tipi">Anestezi Tipi:</label>
                        <select name="anestezi_tipi" id="anestezi_tipi">
                            <option value="Anestezi Yok">Anestezi Yok</option>
                            <option value="Lokal Anestezi">Lokal Anestezi</option>
                            <option value="Sedasyon/MAC">Sedasyon/MAC</option>
                            <option value="Genel Anestezi">Genel Anestezi</option>
                        </select>
                    </div>
                </fieldset>
            </div>
            <div class="form-column">
                <div id="hazirlik-listesi-container">
                    <h3>İşlem Hazırlık Kontrol Listesi</h3>
                    <div id="hazirlik-listesi-icerik">
                        <p class="placeholder">Lütfen bir işlem seçiniz...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-actions">
            <a href="{{ url_for('ana_sayfa') }}" class="button-cancel">İptal</a>
            <button type="submit" class="button-submit">Randevu Oluştur</button>
        </div>
    </form>
</div>
<script>
    //... (JavaScript kodları aynı kalıyor)
    document.addEventListener('DOMContentLoaded', function() {
        const ilkListe = document.getElementById('islem-secim-listesi-1');
        if (ilkListe.options.length > 0) { islemDetayGetir(ilkListe); }
    });

    async function islemDetayGetir(selectElement) {
        const islemAdi = selectElement.value;
        const container = document.getElementById('hazirlik-listesi-icerik');
        container.innerHTML = '<p>Yükleniyor...</p>';
        try {
            const response = await fetch(`/api/islem_detay/${encodeURIComponent(islemAdi)}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            let html = `<h4>${islemAdi}</h4>`;
            html += `<p><strong>Tahmini Süre:</strong> ${data.sure_dk} dakika</p>`;
            html += '<ul class="checklist">';
            data.hazirlik_listesi.forEach(item => {
                html += `<li><label><input type="checkbox" name="hazirlik_maddesi" value="${item}"> ${item}</label></li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = '<p class="error">Hazırlık listesi yüklenemedi.</p>';
            console.error('Hata:', error);
        }
    }

    function kategoriDegistir() {
        var sgRadio = document.getElementById('skopi-gerektirmeyen-radio');
        var sGerektirenSecim = document.getElementById('skopi-gerektiren-secim');
        var sGerektirmeyenSecim = document.getElementById('skopi-gerektirmeyen-secim');
        var sGerektirenSelect = document.getElementById('islem-secim-listesi-2');
        var sGerektirmeyenSelect = document.getElementById('islem-secim-listesi-1');

        if (sgRadio.checked) {
            sGerektirmeyenSecim.style.display = 'block'; sGerektirmeyenSelect.disabled = false;
            sGerektirenSecim.style.display = 'none'; sGerektirenSelect.disabled = true;
            islemDetayGetir(sGerektirmeyenSelect);
        } else {
            sGerektirmeyenSecim.style.display = 'none'; sGerektirmeyenSelect.disabled = true;
            sGerektirenSecim.style.display = 'block'; sGerektirenSelect.disabled = false;
            islemDetayGetir(sGerektirenSelect);
        }
    }
</script>
{% endblock %}